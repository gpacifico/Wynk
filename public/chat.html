<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat Application</title>
  <script src="./js/socket.io.js"></script>
  <script>
    var userObject = {
      "_id": {
          "$oid": "58c089a1b83804084bc7ebff"
      },
      "fbToken": "10155863040702564",
      "dates": [],
      "__v": 15,
      "biography": "this is after i changed back to the old branch",
      "email": "jasonmarker@gmail.com",
      "gender": "male",
      "name": "Tim Marker",
      "username": "newusername",
      "age": 123,
      "hangouts": [
          {
              "_id": {
                  "$oid": "58c977d94535e703a8218e75"
              },
              "first_person": {
                "fbToken": "10155863040702564",
                "name": "Tim Marker"
              },
              "activity": {
                  "review_count": 83,
                  "distance": 12263.8064893,
                  "is_closed": false,
                  "phone": "+17142104585",
                  "rating": 4.5,
                  "name": "Lyon Air Museum",
                  "display_phone": "(714) 210-4585",
                  "image_url": "https://s3-media2.fl.yelpcdn.com/bphoto/IaXGgBY7H3gfX-lVhoUYjg/o.jpg",
                  "id": "lyon-air-museum-santa-ana",
                  "url": "https://www.yelp.com/biz/lyon-air-museum-santa-ana?adjust_creative=RacSYb9qeA-Ow3Om2netXA&utm_campaign=yelp_api_v3&utm_medium=api_v3_business_search&utm_source=RacSYb9qeA-Ow3Om2netXA",
                  "_id": {
                      "$oid": "58c977d94535e703a8218e76"
                  },
                  "categories": [
                      {
                          "title": "Museums",
                          "alias": "museums",
                          "_id": {
                              "$oid": "58c977d94535e703a8218e78"
                          }
                      },
                      {
                          "title": "Venues & Event Spaces",
                          "alias": "venues",
                          "_id": {
                              "$oid": "58c977d94535e703a8218e77"
                          }
                      }
                  ],
                  "transactions": [],
                  "coordinates": {
                      "longitude": -117.873524129391,
                      "latitude": 33.6735375970602
                  },
                  "location": {
                      "city": "Santa Ana",
                      "address1": "19300 Ike Jones Rd",
                      "address3": "",
                      "state": "CA",
                      "zip_code": "92707",
                      "address2": "",
                      "country": "US",
                      "display_address": [
                          "19300 Ike Jones Rd",
                          "Santa Ana, CA 92707"
                      ]
                  }
              },
              "__v": 0,
              "second_person": {
                "fbToken": "100162377184177",
                "name": "Sharon"
              },
              'chat': [
                {
                  'user': '10155863040702564',
                  'name': 'Tim',
                  'message': 'Chat 1 this is chat 1 second message'
                },
                {
                  'user': '109890509549879',
                  'name': 'Sharon',
                  'message': 'Chat 1 first message'
                }
              ]
          },
          {
              "_id": {
                  "$oid": "58c8e7604c97a0051260ad1c"
              },
              "first_person": {
                "fbToken": "10155863040702564",
                "name": "Tim Marker"
              },
              "activity": {
                  "name": "AMC Woodbridge 5",
                  "review_count": 491,
                  "distance": 5977.192401496,
                  "url": "https://www.yelp.com/biz/amc-woodbridge-5-irvine?adjust_creative=RacSYb9qeA-Ow3Om2netXA&utm_campaign=yelp_api_v3&utm_medium=api_v3_business_search&utm_source=RacSYb9qeA-Ow3Om2netXA",
                  "id": "amc-woodbridge-5-irvine",
                  "image_url": "https://s3-media2.fl.yelpcdn.com/bphoto/UIZLCy5aB1465ZKNTcKLyQ/o.jpg",
                  "phone": "+19497333795",
                  "is_closed": false,
                  "rating": 4,
                  "display_phone": "(949) 733-3795",
                  "_id": {
                      "$oid": "58c8e7604c97a0051260ad1d"
                  },
                  "categories": [
                      {
                          "title": "Cinema",
                          "alias": "movietheaters",
                          "_id": {
                              "$oid": "58c8e7604c97a0051260ad1e"
                          }
                      }
                  ],
                  "transactions": [],
                  "coordinates": {
                      "longitude": -117.799719125032,
                      "latitude": 33.6783072352409
                  },
                  "location": {
                      "address3": "",
                      "city": "IRVINE",
                      "country": "US",
                      "zip_code": "92604",
                      "state": "CA",
                      "address1": "4626 Barranca Pkwy",
                      "address2": "",
                      "display_address": [
                          "4626 Barranca Pkwy",
                          "IRVINE, CA 92604"
                      ]
                  }
              },
              "__v": 0,
              "second_person": {
                "fbToken": "1001623771841772",
                "name": "Sharona"
              },
              'chat': [
                {
                  'user': '10155863040702564',
                  'name': 'Tim',
                  'message': 'I am doing fine, you?'
                },
                {
                  'user': '1001623771841772',
                  'name': 'Sharona',
                  'message': 'Hi, how are you?'
                }
              ]
          }
      ]
    }

    var activeChat = "10155863040702564+100162377184177";
    var chat1 = userObject.hangouts[0].first_person.fbToken + "+" + userObject.hangouts[0].second_person.fbToken;
                
    

    window.addEventListener('load', function () {

      //fake data

      var name = '';
      var room = chat1;

      var socket = io();
      socket.emit('changeRoom', { roomName: room });

      addChatToPage(userObject, socket);

      // Username Fix
      // socket.emit('changeUserName', { userName: Math.floor(Math.random()*100) });
      // Username Hack

      var form = document.getElementById('form');

      form.addEventListener('submit', function (e) {
        submitMessage(e, socket, room);
      });

      socket.on('chat message', function (msg) {
        ulElement = document.getElementById('messages');
        var li = getElementFromText(msg, 'li');
        ulElement.appendChild(li);
        ulElement.scrollTop = ulElement.scrollHeight;
      });

      // Change Room or Name

      document.getElementById('change-name').addEventListener('click', function () {
        name = document.getElementById('name').value;
        socket.emit('changeUserName', { userName: name });
        console.log('name: ' + name);
      });

      document.querySelectorAll('.change-room').forEach(function (item) {
        item.addEventListener('click', function () {
          room = this.innerText;
          console.log(room);
          socket.emit('changeRoom', { roomName: room });
          console.log('room: ' + room);
        });
      });

      socket.on('join', function (room) {
        console.log('join room', room);
        socket.room = room;
        socket.join(room);
      })

      document.getElementById('input').addEventListener('input', function (e) {
        if (document.getElementById('input').value) {
          socket.emit('keypress', { room: room, message: true });
        } else if (document.getElementById('input').value === '') {
          socket.emit('keypress', { room: room, message: false });
        }
      })


      socket.on('keypress', function (nickname) {
        var typing = document.getElementById('typing');
        if (nickname) {
          typing.textContent = nickname + ' is typing';
        } else if (!nickname) {
          typing.textContent = '';
        }
      });

    });

    function submitMessage(e, socket, room) {
      e.preventDefault();
      if (document.getElementById('input').value === '') return;
      var message = document.getElementById('input').value;
      console.log('socket: ', socket);
      socket.emit('chat message', { room: room, message: message });
      document.getElementById('input').value = '';
      console.log('room name', room);
      socket.emit('keypress', { room: room, message: false });
      return false;
    }

    function getElementFromText(text, type) {
      var tn = document.createTextNode(text);
      var element = document.createElement(type);
      element.appendChild(tn);
      return element;
    }

    function addChatToPage(userObject, socket) {
      var roomContainer = document.getElementById('room-container');
      for (var i = 0; i < userObject.hangouts.length; i++) {
        (function () {
          var chatroom = userObject.hangouts[i].first_person.fbToken + '+' + userObject.hangouts[i].second_person.fbToken;

          var hangout = userObject.hangouts[i];
          var otherPerson = (userObject.fbToken === userObject.hangouts[i].first_person.fbToken) ? userObject.hangouts[i].second_person : userObject.hangouts[i].first_person;
          console.log('Other Person: ', otherPerson);
          var btn = document.createElement('button');
          var tn = document.createTextNode(otherPerson.name);
          btn.appendChild(tn);

          btn.addEventListener('click', function (e) {
            socket.emit('changeRoom', { roomName: chatroom })
          })

          roomContainer.appendChild(btn);
        }())
      }
    }


  </script>
  <style>
    body { font-size: 0; }
    body > * { font-size: 1rem; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font: 13px Helvetica, Arial; }
    form { padding: 3px; width: 100%; width: 100%; }
    form input { height: 3em; width: 78%; }
    form button { height: 3em; width: 20%; background: rgb(130, 224, 255); border: none; }
    #messages { list-style-type: none; margin: 0; padding: 0; height: 300px; overflow-y: scroll; }
    #messages li { padding: 5px 10px; }
    #messages li:nth-child(odd) { background: #eee; }

    #text-container { width: 100% }
    #typing { height: 1em; }

    .chat-window { max-width: 300px; max-height: 280px; }

  </style>
</head>
<body>
  <h1>Generic Chat Application</h1>
  <div id="room-container"></div>
  <br />
  <input id="name" name="name" placeholder="name"><button id="change-name">Change Name</button>
  <div class="chat-window">
    <ul id="messages"></ul>

    <div id="text-container">
      <p id='typing'></p>
      <form id="form" action="">
        <input id="input"><button>Send</button>
      </form>
    </div>
  </div>
</body>
</html>